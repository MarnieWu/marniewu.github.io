{"title":"å¹¶å‘ Concurrency","uid":"d644caf05d644047d4c92cde0f070d6e","slug":"concurrency","date":"2025-01-28T13:38:22.000Z","updated":"2025-02-13T09:35:58.057Z","comments":true,"path":"api/articles/concurrency.json","keywords":"","cover":[],"content":"<h2 id=\"Concurrency-in-Rust\"><a href=\"#Concurrency-in-Rust\" class=\"headerlink\" title=\"Concurrency in Rust\"></a>Concurrency in Rust</h2><p>åœ¨ Rust ä¸­ï¼Œå¹¶å‘ï¼ˆConcurrencyï¼‰æ˜¯ä¸€é¡¹æ ¸å¿ƒåŠŸèƒ½ï¼Œæ—¨åœ¨å®‰å…¨é«˜æ•ˆçš„åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚</p>\n<h2 id=\"Spawning-Thread\"><a href=\"#Spawning-Thread\" class=\"headerlink\" title=\"Spawning Thread\"></a>Spawning Thread</h2><p>é»˜è®¤ä»£ç ä¸­çš„ä»»åŠ¡éƒ½æ˜¯åœ¨ä¸»çº¿ç¨‹ä¸­æ‰§è¡Œçš„ï¼ŒRust åœ¨æ ‡å‡†åº“ä¸­æä¾›äº† thread æ¨¡å—ï¼Œæä¾›äº†æ“ä½œçº¿ç¨‹çš„èƒ½åŠ›ã€‚</p>\n<h3 id=\"Creating-new-thread\"><a href=\"#Creating-new-thread\" class=\"headerlink\" title=\"Creating new thread\"></a>Creating new thread</h3><figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::thread::spawn;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">fn</span> <span class=\"title function_\">main</span>() &#123;</span><br><span class=\"line\">  <span class=\"title function_ invoke__\">spawn_thread</span>();</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"title function_\">spawn_thread</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">thread_fn</span> = || &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">x</span> = <span class=\"number\">0u128</span>;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> <span class=\"variable\">i</span> <span class=\"keyword\">in</span> <span class=\"number\">1</span>..<span class=\"number\">50_000_000</span> &#123;</span><br><span class=\"line\">            x += i;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;worker get x = &#123;&#125;&quot;</span>, x);</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Starting new worker thread...&quot;</span>);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">handle</span> = <span class=\"title function_ invoke__\">spawn</span>(thread_fn);</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">handle2</span> = <span class=\"title function_ invoke__\">spawn</span>(thread_fn);</span><br><span class=\"line\"></span><br><span class=\"line\">   <span class=\"keyword\">loop</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> handle.<span class=\"title function_ invoke__\">is_finished</span>() &amp;&amp; handle2.<span class=\"title function_ invoke__\">is_finished</span>() &#123;</span><br><span class=\"line\">            <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Worker 1,2 are completed...&quot;</span>);</span><br><span class=\"line\">            <span class=\"keyword\">break</span>;</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">  </span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Worker threads are all finished...&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Main thread has finished...&quot;</span>);</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<h4 id=\"std-thread-spawn-closure\"><a href=\"#std-thread-spawn-closure\" class=\"headerlink\" title=\"std::thread::spawn(closure)\"></a><code>std::thread::spawn(closure)</code></h4><p><code>std::thread::spawn</code> æ–¹æ³•ç”¨äºåˆ›å»ºå·¥ä½œçº¿ç¨‹ï¼Œæ¥å—ä¸€ä¸ªé—­åŒ…ï¼Œé—­åŒ…å†…å†™éœ€è¦åœ¨è¯¥çº¿ç¨‹å†…æ‰§è¡Œçš„ä»»åŠ¡ï¼Œè¯¥æ–¹æ³•è¿”å›ä¸€ä¸ª <code>JoinHandle</code> ç»“æ„ä½“ã€‚é»˜è®¤ä¸»çº¿ç¨‹ä¸Šçš„ä»»åŠ¡å’Œå·¥ä½œçº¿ç¨‹æ˜¯éšæœºæ‰§è¡Œçš„ï¼Œæ— æ³•å›ºå®šæ‰§è¡Œé¡ºåºï¼Œå·¥ä½œçº¿ç¨‹ä¾èµ–äºä¸»çº¿ç¨‹åˆ›å»ºï¼Œä¸»çº¿ç¨‹ä¸€æ—¦é€€å‡ºåï¼Œå³ä½¿æœ‰æœªæ‰§è¡Œå®Œçš„å·¥ä½œçº¿ç¨‹ä¸Šçš„ä»»åŠ¡ï¼Œä¹Ÿä¼šç›´æ¥ç»“æŸã€‚</p>\n<p><code>JoinHandle</code> ç»“æ„ä½“æä¾›äº†ä¸€äº›æ–¹æ³•ï¼Œå…¶ä¸­å°±æœ‰é˜»æ­¢ä¸»çº¿ç¨‹ç»ˆç»“çš„ <code>join</code> æ–¹æ³•ï¼Œè°ƒç”¨è¯¥æ–¹æ³•å¯ä»¥é˜»æ­¢ä¸»çº¿ç¨‹çš„ç»“æŸï¼Œå®ƒä¼šç­‰åˆ°è¯¥å·¥ä½œçº¿ç¨‹æ‰€æœ‰ä»»åŠ¡å®Œæˆåå†é€€å‡ºã€‚</p>\n<h4 id=\"join-æ–¹æ³•\"><a href=\"#join-æ–¹æ³•\" class=\"headerlink\" title=\"join æ–¹æ³•\"></a><code>join</code> æ–¹æ³•</h4><p>ä¸Šé¢çš„ä¾‹å­æˆ‘ä»¬åœ¨ä¸»çº¿ç¨‹å†™äº†ä¸€ä¸ª <code>loop</code> å‡½æ•°æ¥ä¸€ç›´æ‰§è¡Œï¼Œç›´åˆ° worker threadï¼ˆhandle+handle2ï¼‰ æ‰§è¡Œå®Œæ¯•ã€‚<code>is_finished()</code> æ–¹æ³•æ˜¯ <code>JoinHandle</code> æä¾›çš„ç”¨äºæŸ¥è¯¢å·¥ä½œçº¿ç¨‹æ˜¯å¦ç»“æŸçš„æ–¹æ³•ã€‚é™¤æ­¤ä¹‹å¤–ç”¨ <code>join</code> èƒ½è®©ä¸»çº¿ç¨‹ç­‰å¾…å·¥ä½œçº¿ç¨‹çš„æ‰§è¡Œã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">handle</span> = <span class=\"title function_ invoke__\">spawn</span>(thread_fn);</span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">handle2</span> = <span class=\"title function_ invoke__\">spawn</span>(thread_fn);</span><br><span class=\"line\"></span><br><span class=\"line\">handle.<span class=\"title function_ invoke__\">join</span>();</span><br><span class=\"line\">handle2.<span class=\"title function_ invoke__\">join</span>();</span><br></pre></td></tr></table></figure>\n\n\n\n<h4 id=\"Thread-variables-çº¿ç¨‹å˜é‡\"><a href=\"#Thread-variables-çº¿ç¨‹å˜é‡\" class=\"headerlink\" title=\"Thread variables çº¿ç¨‹å˜é‡\"></a>Thread variables çº¿ç¨‹å˜é‡</h4><p><code>spawn</code> æ–¹æ³•æ¥æ”¶ä¸€ä¸ªé—­åŒ…ï¼Œæˆ‘ä»¬åœ¨å­¦é—­åŒ…éƒ¨åˆ†çš„æ—¶å€™æœ‰æè¿‡ï¼Œé—­åŒ…çš„ç‰¹æ€§å°±æ˜¯å¯ä»¥è®¿é—®çˆ¶çº§ä½œç”¨åŸŸå†…å®šä¹‰çš„å˜é‡ï¼Œè¢«ç§°ä¸º capturing variablesï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨æ–°çº¿ç¨‹é—­åŒ…å‡½æ•°å†…æ˜¯å¯ä»¥è®¿é—®çˆ¶çº§ä½œç”¨åŸŸçš„å˜é‡çš„ã€‚æ¯”å¦‚ä¸‹å›¾ä¾‹å­ï¼š</p>\n<p><img src=\"/../images/concurrency/image-20250207203619887.png\" alt=\"image-20250207203619887\"></p>\n<p><code>print_age</code> é—­åŒ…å†…ä½¿ç”¨äº†çˆ¶çº§ä½œç”¨åŸŸçš„ <code>user</code> å˜é‡ï¼Œè¿™æ—¶ Rust ä¼šå°è¯•åƒçˆ¶çº§ä½œç”¨åŸŸå€Ÿç”¨ <code>user</code>ï¼Œç„¶è€Œå°±ä¼šå‡ºç°æŠ¥é”™ä¸Šçš„è¿™ä¸ªé—®é¢˜ï¼šRust å¹¶ä¸çŸ¥é“è¿™ä¸ªé—­åŒ…ä¼šå­˜æ´»å¤šä¹…æˆ–è€…æ›´è¿›ä¸€æ­¥ï¼Œå› ä¸ºè¿™ä¸ªé—­åŒ…æ˜¯ä¼ å…¥ <code>spawn</code> æ–¹æ³•åˆ›å»ºæ–°çº¿ç¨‹æ—¶ç”¨çš„ï¼ŒRust å¹¶ä¸çŸ¥é“è¿™ä¸ªæ–°çº¿ç¨‹ä¼šå­˜æ´»å¤šä¹…ï¼Œæ‰€ä»¥å®ƒæ— æ³•ç¡®è®¤è¢«å€Ÿç”¨çš„ <code>user</code> ä¸€å®šæ˜¯å­˜åœ¨çš„ï¼ˆæ¯”å¦‚å­çº¿ç¨‹å€Ÿç”¨å˜é‡ï¼Œä¸»çº¿ç¨‹é”€æ¯äº†å˜é‡ï¼‰ï¼Œä¾¿å¾—åˆ°äº†ä¸Šé¢çš„æŠ¥é”™ã€‚</p>\n<p>æ‰€ä»¥å…³äºçº¿ç¨‹ä¸­ä½¿ç”¨å¤–éƒ¨å˜é‡æœ‰ä¸¤ç§è§£å†³æ–¹æ¡ˆï¼š</p>\n<h5 id=\"move-closure-ä½¿ç”¨-move-å…³é”®å­—å°†å˜é‡çš„æ•°æ®æ‰€æœ‰æƒè½¬ç§»åˆ°é—­åŒ…å†…\"><a href=\"#move-closure-ä½¿ç”¨-move-å…³é”®å­—å°†å˜é‡çš„æ•°æ®æ‰€æœ‰æƒè½¬ç§»åˆ°é—­åŒ…å†…\" class=\"headerlink\" title=\"move closure ä½¿ç”¨ move å…³é”®å­—å°†å˜é‡çš„æ•°æ®æ‰€æœ‰æƒè½¬ç§»åˆ°é—­åŒ…å†…\"></a><code>move closure</code> ä½¿ç”¨ move å…³é”®å­—å°†å˜é‡çš„æ•°æ®æ‰€æœ‰æƒè½¬ç§»åˆ°é—­åŒ…å†…</h5><p>è¿™ç›¸å½“äºå‘Šè¯‰ç¼–è¯‘å™¨å°†å˜é‡è½¬ç§»åˆ°çº¿ç¨‹å†…ä½œç”¨åŸŸï¼Œçº¿ç¨‹ç»“æŸåä¼šè‡ªåŠ¨ <code>drop</code> å˜é‡ã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::thread::spawn;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">m</span> = <span class=\"number\">10</span>;</span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">thread_fn</span> = <span class=\"keyword\">move</span> || &#123;</span><br><span class=\"line\">  m += <span class=\"number\">1</span>;</span><br><span class=\"line\">  <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;m = &#123;&#125;&quot;</span>, m);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_ invoke__\">spawn</span>(thread_fn);</span><br></pre></td></tr></table></figure>\n\n<p>ä¸Šé¢çš„ <code>move closure</code> åªé€‚ç”¨äºåªéœ€è¦åœ¨å­çº¿ç¨‹å†…ä½¿ç”¨çš„å˜é‡ï¼Œè‹¥åœ¨å­çº¿ç¨‹ç»“æŸåè¿˜éœ€è¦ä½¿ç”¨çš„å˜é‡æˆ‘ä»¬å°±éœ€è¦æ”¹ç”¨ <code>thread::scope</code> æ–¹æ³•ã€‚</p>\n<h5 id=\"std-thread-scope\"><a href=\"#std-thread-scope\" class=\"headerlink\" title=\"std::thread::scope\"></a><strong><code>std::thread::scope</code></strong></h5><p>æ™®é€šçš„ threads æ˜¯ non-scoped threadsï¼Œä½¿ç”¨ <code>thread::scope</code> æä¾›ä¸€ä¸ª <code>Scope</code> å¯¹è±¡ï¼Œç”¨è¯¥å¯¹è±¡æä¾›çš„ <code>spawn</code> æ–¹æ³•æ”¯æŒåˆ›å»ºå¸¦ä½œç”¨åŸŸçš„çº¿ç¨‹ï¼Œå®ƒä¼šç¡®ä¿ç­‰å¾…è¿™ä¸ª scope å†…åˆ›å»ºçš„æ‰€æœ‰çº¿ç¨‹çš„ä»»åŠ¡éƒ½æ‰§è¡Œå®Œæ¯•åæ‰ä¼šç¦»å¼€å½“å‰ä½œç”¨åŸŸï¼Œè¿™ç§è‡ªåŠ¨ç­‰å¾…çš„æœºåˆ¶ä¾¿è®©ç¼–è¯‘å™¨å¯ä»¥<strong>æ¨æ–­</strong>å˜é‡å€Ÿç”¨çš„ç”Ÿå‘½å‘¨æœŸï¼Œä¸éœ€è¦å†æ‰‹åŠ¨è½¬ç§»å˜é‡æ‰€æœ‰æƒã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::thread::scope;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">user</span> = Person &#123;</span><br><span class=\"line\">  name: <span class=\"type\">String</span>::<span class=\"title function_ invoke__\">from</span>(<span class=\"string\">&quot;Mark&quot;</span>),</span><br><span class=\"line\">  age: <span class=\"number\">20</span>,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">print_name</span> = || &#123;</span><br><span class=\"line\">  <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;My name is &#123;&#125;.&quot;</span>, user.name);</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"title function_ invoke__\">scope</span>(|s| &#123;</span><br><span class=\"line\">  s.<span class=\"title function_ invoke__\">spawn</span>(print_name);</span><br><span class=\"line\">&#125;);</span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"Message-Passing-with-MPSC-channels\"><a href=\"#Message-Passing-with-MPSC-channels\" class=\"headerlink\" title=\"Message Passing with MPSC channels\"></a>Message Passing with MPSC channels</h2><p>çº¿ç¨‹é—´çš„é€šä¿¡æ–¹å¼ä¸ºï¼šMessage Passing æ¶ˆæ¯ä¼ é€’ã€‚æ¶ˆæ¯ä¼ é€’çš„è½½ä½“æ˜¯ <code>channel</code> ï¼Œ<code>channel</code> åˆ†ä¸ºä¸€ä¸ªå‘é€æ–¹ï¼ˆtransmitterï¼‰ä¸€ä¸ªæ¥æ”¶æ–¹ï¼ˆreceiverï¼‰ã€‚</p>\n<p>ä½¿ç”¨ <code>mpsc::channel</code> å‡½æ•°åˆ›å»º <code>channel</code>ï¼Œ<strong>mpsc meanings multiple producer single consumerï¼ˆå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…ï¼‰</strong>ã€‚</p>\n<h3 id=\"é€šä¿¡åŸåˆ™\"><a href=\"#é€šä¿¡åŸåˆ™\" class=\"headerlink\" title=\"é€šä¿¡åŸåˆ™\"></a>é€šä¿¡åŸåˆ™</h3><p>é»˜è®¤æƒ…å†µï¼Œ<code>channel</code> é—´æ¶ˆæ¯é€šä¿¡éƒ½éœ€è¦éµå®ˆå¤šç”Ÿäº§è€…å•æ¶ˆè´¹è€…çš„åŸåˆ™ï¼Œè¿™æ˜¯ä¸ºäº†é˜²æ­¢æ•°æ®ç«äº‰ï¼ˆdata racingï¼‰ï¼Œå¯ä»¥æœ‰å¤šä¸ªçº¿ç¨‹è¿›è¡Œç”Ÿäº§æ¶ˆæ¯ï¼Œä½†æ˜¯æ¶ˆè´¹æˆ–è€…è¯´æ¥æ”¶ã€å¤„ç†æ¶ˆæ¯çš„çº¿ç¨‹åªèƒ½æœ‰ä¸€ä¸ªã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::sync::mpsc;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// åˆ›å»ºä¸€ä¸ª channel</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> (tx, rx) = mpsc::<span class=\"title function_ invoke__\">channel</span>();</span><br><span class=\"line\"><span class=\"comment\">// txï¼šå‘é€æ–¹ï¼Œrxï¼šæ¥æ”¶æ–¹</span></span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"å¤šä¸ªç”Ÿäº§è€…-multiple-producers\"><a href=\"#å¤šä¸ªç”Ÿäº§è€…-multiple-producers\" class=\"headerlink\" title=\"å¤šä¸ªç”Ÿäº§è€… multiple producers\"></a>å¤šä¸ªç”Ÿäº§è€… multiple producers</h3><p>åˆ›å»º <code>channel</code> åï¼Œé»˜è®¤å¾—åˆ°ä¸€ä¸ªç”Ÿäº§è€…ä¸€ä¸ªæ¶ˆè´¹è€…ï¼Œå¦‚æœéœ€è¦ä½¿ç”¨å¤šä¸ªçº¿ç¨‹è¿›è¡Œæ¶ˆæ¯ç”Ÿäº§çš„åœºæ™¯ï¼Œæˆ‘ä»¬å¯ä»¥ä½¿ç”¨ <code>clone()</code> æ–¹æ³•å…‹éš†åŸç”Ÿäº§è€…ï¼Œæ¥åˆ›å»ºè¯¥ <code>channel</code> å¤šä¸ªç”Ÿäº§è€…ã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::sync::mpsc;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// åˆ›å»ºä¸€ä¸ª channel</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> (tx, rx) = mpsc::<span class=\"title function_ invoke__\">channel</span>();</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// ä½¿ç”¨ Sender::clone æ–¹æ³•ï¼Œcloneä¸€ä¸ªç”Ÿäº§è€…ï¼ˆç¬¦åˆchannelå¤šä¸ªç”Ÿäº§è€…çš„ä¸»æ—¨ï¼‰</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">tx2</span> = mpsc::Sender::<span class=\"title function_ invoke__\">clone</span>(&amp;tx);</span><br><span class=\"line\"><span class=\"comment\">// æˆ–è€… clone trait æ–¹æ³•</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">tx3</span> = tx.<span class=\"title function_ invoke__\">clone</span>();</span><br></pre></td></tr></table></figure>\n\n\n\n<h3 id=\"Sharing-data-within-multiple-threads\"><a href=\"#Sharing-data-within-multiple-threads\" class=\"headerlink\" title=\"Sharing data within multiple threads\"></a>Sharing data within multiple threads</h3><p>ä¸Šé¢è¯´åˆ°ï¼Œä¸ºäº†æ•°æ®å®‰å…¨æ€§çš„è€ƒè™‘ï¼Œæˆ‘ä»¬éœ€è¦éµå®ˆåªèƒ½å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹æ¶ˆè´¹ï¼ˆè¯»å–ï¼‰æ¶ˆæ¯çš„åŸåˆ™ã€‚ä½†å¦‚æœå°±æ˜¯é‡åˆ°äº†éœ€è¦<strong>å¤šä¸ªçº¿ç¨‹é‡Œéƒ½å¯èƒ½ä½¿ç”¨ä¸€ä¸ªæ¶ˆæ¯</strong>çš„åœºæ™¯ï¼Œå³<strong>å¤šç”Ÿäº§è€…å¤šæ¶ˆè´¹è€…</strong>ï¼Œæˆ‘ä»¬ä¹Ÿæ˜¯å¯ä»¥æ”¯æŒçš„ï¼Œä½†<strong>å§‹ç»ˆéµå®ˆåŒä¸€æ—¶é—´åªèƒ½å­˜åœ¨ä¸€ä¸ªçœŸå®æ¶ˆè´¹æ¶ˆæ¯çš„çº¿ç¨‹</strong>ã€‚éœ€è¦ä½¿ç”¨ <strong><code>Mutex</code> äº’æ–¥é” + <code>Arc</code> æ™ºèƒ½æŒ‡é’ˆ</strong>  ï¼š</p>\n<p><code>Mutex</code> ç”¨æ¥é˜²æ­¢å¤šçº¿ç¨‹ä¸‹çš„æ•°æ®ç«äº‰ï¼Œ<code>Arc</code> æ™ºèƒ½æŒ‡é’ˆç”¨æ¥å®ç°æ•°æ®å…±äº«åŠå¤šçº¿ç¨‹ä¸‹éœ€è¦å…±äº«çš„æ•°æ®çš„å®‰å…¨æ€§ã€‚</p>\n<h4 id=\"Mutex-äº’æ–¥é”-æ˜¯ä»€ä¹ˆ\"><a href=\"#Mutex-äº’æ–¥é”-æ˜¯ä»€ä¹ˆ\" class=\"headerlink\" title=\"Mutex äº’æ–¥é” æ˜¯ä»€ä¹ˆ\"></a>Mutex äº’æ–¥é” æ˜¯ä»€ä¹ˆ</h4><p><code>Mutex</code> è®©å¤šä¸ªçº¿ç¨‹å¹¶å‘çš„è®¿é—®åŒä¸€ä¸ªå€¼å˜æˆäº†æ’é˜Ÿè®¿é—®ï¼š<strong>åŒä¸€æ—¶é—´ï¼Œåªå…è®¸ä¸€ä¸ªçº¿ç¨‹<code>A</code>è®¿é—®è¯¥å€¼ï¼Œå…¶å®ƒçº¿ç¨‹éœ€è¦ç­‰å¾…<code>A</code>è®¿é—®å®Œæˆåæ‰èƒ½ç»§ç»­</strong>ã€‚</p>\n<p>è¿™å°±å¾ˆç¬¦åˆæˆ‘ä»¬ <strong>mpsc</strong> çš„åŸåˆ™ï¼Œä¸€èˆ¬å•çº¿ç¨‹ä¸­æˆ‘ä»¬å¹¶ä¸éœ€è¦ä½¿ç”¨äº’æ–¥é”ï¼Œå•çº¿ç¨‹ä¸­æœ¬æ¥å°±éœ€è¦éµå®ˆæ‰€æœ‰æƒçš„é™åˆ¶ï¼Œå¾ˆå¤§ç¨‹åº¦çš„é¿å…äº†åŒæ—¶è¯»å†™çš„åœºæ™¯ã€‚æ‰€ä»¥äº’æ–¥é”çš„åœºæ™¯ä¸€èˆ¬éƒ½æ˜¯ç”¨äºå¤šçº¿ç¨‹è®¿é—®åŒä¸€ä¸ªå€¼ã€‚</p>\n<h4 id=\"Mutex-æ€ä¹ˆä½¿ç”¨\"><a href=\"#Mutex-æ€ä¹ˆä½¿ç”¨\" class=\"headerlink\" title=\"Mutex æ€ä¹ˆä½¿ç”¨\"></a>Mutex æ€ä¹ˆä½¿ç”¨</h4><h5 id=\"åˆ›å»º\"><a href=\"#åˆ›å»º\" class=\"headerlink\" title=\"åˆ›å»º\"></a>åˆ›å»º</h5><figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// åˆ›å»ºä¸€ä¸ª Mutex ç»“æ„ä½“å˜é‡</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">m</span> = Mutex::<span class=\"title function_ invoke__\">new</span>(<span class=\"number\">5</span>);</span><br></pre></td></tr></table></figure>\n\n<p><code>Mutex</code> æ˜¯ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œå®ƒä¼šç±»ä¼¼ <code>Box</code> æ™ºèƒ½æŒ‡é’ˆä¸€æ ·æŒæœ‰æ•°æ®ã€‚</p>\n<h5 id=\"è®¿é—®\"><a href=\"#è®¿é—®\" class=\"headerlink\" title=\"è®¿é—®\"></a>è®¿é—®</h5><p>è®¿é—®å†…éƒ¨çš„æ•°æ®éœ€è¦ä½¿ç”¨ <code>lock()</code> æ–¹æ³•å‘ <code>Mutex</code> å˜é‡ç”³è¯·ä¸€ä¸ª<strong>é”</strong>ï¼Œè¯¥æ–¹æ³•ä¼šæŒ‚èµ·å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°è·å–åˆ°é”ï¼Œä¸€æ—¦æœ‰æŸä¸€æ¡çº¿ç¨‹è·å–åˆ°äº†é”ï¼Œå…¶ä»–çº¿ç¨‹è·å–é”ä¾¿ä¼šè¢«é˜»å¡ï¼Œç›´åˆ°å·²ç»è·å–é”çš„çº¿ç¨‹å°†é”é‡Šæ”¾ï¼Œè¿™æ ·ä¾¿å¯ä»¥ä¿è¯ï¼ŒåŒæ—¶åªä¼šæœ‰ä¸€æ¡çº¿ç¨‹åœ¨æ“ä½œæ•°æ®ã€‚</p>\n<p><code>lock()</code> æ–¹æ³•è¿”å›ç±»å‹ä¸º <code>LockResult&lt;MutexGuard&gt;</code>ï¼Œä¸€ä¸ªç”¨ <code>Result</code> åŒ…è£¹çš„ <code>MutexGuard</code> æ™ºèƒ½æŒ‡é’ˆï¼Œæ‰€ä»¥è¦è®¿é—®å†…éƒ¨æ•°æ®éœ€è¦å…ˆä½¿ç”¨ <code>unwarp()</code> å¾—åˆ°æ™ºèƒ½æŒ‡é’ˆï¼Œå†æŒ‰ç…§å…·ä½“ç±»å‹æ“ä½œå†…éƒ¨æ•°æ®ã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"comment\">// åˆ›å»ºäº†ä¸€ä¸ªMutex</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">score</span> = Mutex::<span class=\"title function_ invoke__\">new</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// lock()å¾—åˆ°Result</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"variable\">unlocked_data</span> = score.<span class=\"title function_ invoke__\">lock</span>();</span><br><span class=\"line\"><span class=\"comment\">// unwrap()å¾—åˆ°MutexGuard</span></span><br><span class=\"line\"><span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">data</span> = unlocked_data.<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\"><span class=\"comment\">// æ“ä½œdata</span></span><br><span class=\"line\">data.<span class=\"title function_ invoke__\">add_assign</span>(<span class=\"number\">20</span>);</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"built_in\">println!</span>(<span class=\"string\">&quot;My score is &#123;&#125;.&quot;</span>, data);</span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>é‚£ä¹ˆï¼Œå¦‚æœåŒæ—¶æœ‰ä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç”³è¯·é”ï¼Œå“ªä¸ªçº¿ç¨‹ä¼šæˆåŠŸå‘¢ï¼Ÿ</strong>æˆ‘ä»¬å°è¯•ç”¨ä»£ç è¿˜åŸä¸€ä¸‹åœºæ™¯ï¼š</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::&#123;ops::AddAssign, sync::Mutex, thread::scope&#125;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"title function_\">test_mutex</span>() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// åˆ›å»ºäº†ä¸€ä¸ª Mutex</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">score</span> = Mutex::<span class=\"title function_ invoke__\">new</span>(<span class=\"number\">100</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// è¿™é‡Œç”³è¯·äº†é”</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">unlocked_data</span> = score.<span class=\"title function_ invoke__\">lock</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">data</span> = unlocked_data.<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">    data.<span class=\"title function_ invoke__\">add_assign</span>(<span class=\"number\">20</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;My score is &#123;&#125;.&quot;</span>, data);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// é‡Šæ”¾ä¸Šä¸€ä¸ªé”ï¼Œâœ¨ è¿™é‡Œå¦‚æœä¸é‡Šæ”¾é‚£ä¹ˆä¸‹é¢çš„çº¿ç¨‹é‡Œæ˜¯æ— æ³•ç”³è¯·åˆ°é”çš„</span></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">drop</span>(data);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">my_func</span> = || &#123;</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Thread 1 is waiting for mutex lock.&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">data</span> = score.<span class=\"title function_ invoke__\">lock</span>().<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> <span class=\"variable\">i</span> <span class=\"keyword\">in</span> <span class=\"number\">1</span>..=<span class=\"number\">10</span> &#123;</span><br><span class=\"line\">            data.<span class=\"title function_ invoke__\">add_assign</span>(i);</span><br><span class=\"line\">            <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Thread 1 is adding &#123;&#125; and score is &#123;&#125;&quot;</span>, i, data);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">my_func2</span> = || &#123;</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Thread 2 is waiting for mutex lock.&quot;</span>);</span><br><span class=\"line\"></span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">data</span> = score.<span class=\"title function_ invoke__\">lock</span>().<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">        <span class=\"keyword\">for</span> <span class=\"variable\">i</span> <span class=\"keyword\">in</span> <span class=\"number\">1</span>..=<span class=\"number\">10</span> &#123;</span><br><span class=\"line\">            data.<span class=\"title function_ invoke__\">add_assign</span>(i);</span><br><span class=\"line\">            <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;Thread 2 is adding &#123;&#125; and score is &#123;&#125;&quot;</span>, i, data);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"title function_ invoke__\">scope</span>(|s| &#123;</span><br><span class=\"line\">        s.<span class=\"title function_ invoke__\">spawn</span>(my_func);</span><br><span class=\"line\">        s.<span class=\"title function_ invoke__\">spawn</span>(my_func2);</span><br><span class=\"line\">    &#125;);</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;The score is &#123;&#125;.&quot;</span>, score.<span class=\"title function_ invoke__\">lock</span>().<span class=\"title function_ invoke__\">unwrap</span>());</span><br><span class=\"line\">&#125;</span><br></pre></td></tr></table></figure>\n\n<p>è¿è¡Œç»“æœå¦‚ä¸‹ï¼š</p>\n<p><img src=\"/../images/concurrency/image-20250209020229062.png\" alt=\"image-20250209020229062\"></p>\n<p>å¯ä»¥çœ‹åˆ°ï¼Œä¸¤ä¸ªçº¿ç¨‹éƒ½åœ¨ç”³è¯·é”ï¼Œä½†æ‰§è¡Œé¡ºåºä¸€å®šæ˜¯ä¸€ä¸ªé”ç”¨å®Œäº†é‡Šæ”¾äº†ä¹‹åä¸‹ä¸€ä¸ªé”æ‰ä¼šç»§ç»­ã€‚</p>\n<p>æˆ‘ä»¬çš„ç›®æ ‡æ˜¯åœ¨å¤šçº¿ç¨‹ä¸‹å®ç°å…±äº«ä¸€ä¸ªæ¶ˆè´¹è€…æ•°æ®ï¼Œé™¤äº†ä½¿ç”¨ <code>Mutex</code> äº’æ–¥é”ä¿è¯å¤šçº¿ç¨‹ä¸‹æ•°æ®çš„<strong>åŒæ­¥è®¿é—®</strong>ï¼Œé˜²æ­¢<strong>æ•°æ®ç«äº‰ï¼ˆdata racingï¼‰</strong>å¤–ï¼Œè¿˜éœ€è¦ä½¿ç”¨æ™ºèƒ½æŒ‡é’ˆå®ç°æ•°æ®å…±äº«ï¼Œå‰é¢å­¦ä¹ è¿‡åœ¨ä¸€æ¡çº¿ç¨‹é‡Œæˆ‘ä»¬ä½¿ç”¨ <code>Rc</code> æ™ºèƒ½æŒ‡é’ˆæ¥å®ç°ä¸€ä¸ªèµ„æºæ‹¥æœ‰å¤šä¸ªæ‰€æœ‰è€…ï¼Œåœ¨å¤šçº¿ç¨‹ä¸‹æ˜¯ä½¿ç”¨ <code>Arc</code> æ™ºèƒ½æŒ‡é’ˆï¼Œå…·ä½“ç”¨æ³•æˆ‘ä»¬åœ¨ç»ƒä¹ éƒ¨åˆ†å†è¿›è¡Œåº”ç”¨ã€‚</p>\n<h2 id=\"ç»ƒä¹ 1\"><a href=\"#ç»ƒä¹ 1\" class=\"headerlink\" title=\"ç»ƒä¹ 1\"></a>ç»ƒä¹ 1</h2><p><img src=\"/../images/concurrency/image-20250131212004428.png\" alt=\"image-20250131212004428\"></p>\n<ul>\n<li><p>process_file å‡½æ•°ï¼šæ¥æ”¶ file_pathï¼Œæ‰“å° file_content</p>\n</li>\n<li><p>ä¸»çº¿ç¨‹ï¼štxï¼ˆå‘é€æ–¹ï¼‰ï¼Œå‡è®¾æœ‰ 10 ä¸ª file_path è¦å¤„ç†ï¼Œéå†å®ƒä»¬è°ƒç”¨ clone æ¥åˆ›å»ºå¤šä¸ªç”Ÿäº§è€…ï¼Œæ¨¡æ‹Ÿå¹¶å‘æ€§çš„å‘é€ file_path</p>\n</li>\n<li><p>å­çº¿ç¨‹ï¼ˆå·¥ä½œçº¿ç¨‹ï¼‰ï¼šrxï¼ˆæ¥æ”¶æ–¹&#x2F;æ¶ˆè´¹è€…ï¼‰ï¼Œè°ƒç”¨ process_file å‡½æ•°ï¼ŒæŒ‰ç…§é¢˜æ„éœ€è¦åˆ›å»ºå¤šä¸ªå·¥ä½œçº¿ç¨‹å»æ¥å—æ¶ˆæ¯ï¼Œå³ä¼šæœ‰å¤šä¸ªçº¿ç¨‹éœ€è¦å€Ÿç”¨æ¶ˆè´¹è€…ã€‚åœ¨å·¥ä½œçº¿ç¨‹å†… loop è®¿é—®æ¥æ”¶æ–¹ï¼Œæ ¹æ®æ¥æ”¶æ–¹ç»“æœå¤„ç†æ¶ˆæ¯ï¼Œç›´åˆ°æ²¡æœ‰å¯è·å–çš„æ¶ˆæ¯ä¸ºæ­¢</p>\n</li>\n<li><p>æœ€å¤šåŒæ—¶å¤„ç† 4 ä¸ªæ–‡ä»¶ï¼šä¸»çº¿ç¨‹ä¸­åŒæ—¶åˆ›å»º4ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹éƒ½å»è®¿é—®æ¶ˆè´¹è€…ï¼Œå¤„ç†æ¶ˆè´¹è€…æ¥æ”¶åˆ°çš„æ¶ˆæ¯</p>\n</li>\n</ul>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">fn</span> <span class=\"title function_\">process_file</span>(path: &amp;<span class=\"type\">str</span>) &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">file_name</span> = <span class=\"type\">String</span>::<span class=\"title function_ invoke__\">from</span>(path);</span><br><span class=\"line\">    file_name.<span class=\"title function_ invoke__\">push_str</span>(<span class=\"string\">&quot;.txt&quot;</span>);</span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸ“” Processing file: &#123;&#125;&quot;</span>, file_name);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">fn</span> <span class=\"title function_\">practice</span>() &#123;</span><br><span class=\"line\">    <span class=\"keyword\">let</span> (tx, rx) = mpsc::<span class=\"title function_ invoke__\">channel</span>();</span><br><span class=\"line\">    <span class=\"comment\">// âœ¨åˆ›å»ºå¤šçº¿ç¨‹ä¸‹å…±äº«çš„rx</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">rx</span> = Arc::<span class=\"title function_ invoke__\">new</span>(Mutex::<span class=\"title function_ invoke__\">new</span>(rx));</span><br><span class=\"line\">    <span class=\"comment\">// åˆ›å»º10ä¸ªfile_path</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">file_paths</span> = <span class=\"built_in\">vec!</span>[];</span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">i</span> <span class=\"keyword\">in</span> <span class=\"number\">1</span>..=<span class=\"number\">10</span> &#123;</span><br><span class=\"line\">        file_paths.<span class=\"title function_ invoke__\">push</span>(<span class=\"built_in\">format!</span>(<span class=\"string\">&quot;&#123;&#125;&quot;</span>, i));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// main thread ä¸­ clone å¤šä¸ª transmitterï¼ˆsenderï¼‰</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">path</span> <span class=\"keyword\">in</span> file_paths &#123;</span><br><span class=\"line\">        <span class=\"comment\">// âœ¨æŒ‰ç…§é¢˜æ„ï¼šä½¿ç”¨å¤šçº¿ç¨‹å®ç°æ–‡ä»¶å¤„ç†çš„å¹¶å‘æ€§ï¼Œä¸»çº¿ç¨‹ä½œä¸ºç”Ÿäº§è€…å‘é€šé“å‘é€æ–‡ä»¶è·¯å¾„</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">cloned_tx</span> = tx.<span class=\"title function_ invoke__\">clone</span>();</span><br><span class=\"line\">        <span class=\"comment\">// å¤šç”Ÿäº§è€… multiple transmitter</span></span><br><span class=\"line\">        cloned_tx.<span class=\"title function_ invoke__\">send</span>(path.<span class=\"title function_ invoke__\">clone</span>()).<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">        <span class=\"comment\">// åŠ ç‚¹å»¶æ—¶ï¼Œçœ‹èµ·æ¥æœ‰æ•ˆæœçš„æ ·å­</span></span><br><span class=\"line\">        thread::<span class=\"title function_ invoke__\">sleep</span>(Duration::<span class=\"title function_ invoke__\">from_millis</span>(<span class=\"number\">100</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// åˆ›å»ºå¤šä¸ªå­çº¿ç¨‹ï¼ˆå·¥ä½œçº¿ç¨‹ï¼‰æ¥å¤„ç†æ¶ˆæ¯</span></span><br><span class=\"line\">    <span class=\"comment\">// å¤„ç†æ¶ˆæ¯ï¼šè°ƒç”¨ process_file å‡½æ•°</span></span><br><span class=\"line\">    <span class=\"comment\">// rxæ˜¯æ¥æ”¶æ–¹ï¼Œæ˜¯Arcæ™ºèƒ½æŒ‡é’ˆåŒ…è£¹çš„Mutexäº’æ–¥é”</span></span><br><span class=\"line\">    <span class=\"comment\">// å…±äº«rxï¼šArc::clone(&amp;rx)</span></span><br><span class=\"line\">    <span class=\"comment\">// âœ¨æŒ‰ç…§é¢˜æ„æˆ‘ä»¬éœ€è¦åˆ›å»ºå¤šä¸ªçº¿ç¨‹å»ä½¿ç”¨rx</span></span><br><span class=\"line\">    <span class=\"comment\">// æœ€å¤šåŒæ—¶å¤„ç†4ä¸ªæ–‡ä»¶</span></span><br><span class=\"line\">    <span class=\"comment\">// handlesç”¨æ¥å­˜å‚¨åˆ›å»ºåçš„çº¿ç¨‹</span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">handles</span> = <span class=\"built_in\">vec!</span>[];</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// åŒæ—¶åˆ›å»º4ä¸ªçº¿ç¨‹</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">i</span> <span class=\"keyword\">in</span> <span class=\"number\">0</span>..<span class=\"number\">4</span> &#123;</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸ”‹ Worker thread &#123;&#125; get starting ...&quot;</span>, i + <span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"comment\">// åˆ›å»ºå…±äº«çš„æ¥æ”¶æ–¹ï¼ŒReference count +1</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">shared_receiver</span> = Arc::<span class=\"title function_ invoke__\">clone</span>(&amp;rx);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">consumer</span> = <span class=\"keyword\">move</span> || &#123;</span><br><span class=\"line\">            <span class=\"keyword\">loop</span> &#123;</span><br><span class=\"line\">                <span class=\"comment\">// ç”³è¯·é”-&gt;è®¿é—®receiver</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> <span class=\"variable\">unlocked_receiver</span> = shared_receiver.<span class=\"title function_ invoke__\">lock</span>();</span><br><span class=\"line\">                <span class=\"comment\">// æ‹¿åˆ°ç”¨Mutexå­˜å‚¨çš„receiver</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> <span class=\"variable\">receiver</span> = unlocked_receiver.<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸ”„ Attempting to receive message from channel ...&quot;</span>);</span><br><span class=\"line\">                <span class=\"comment\">// æ‹¿åˆ°receiverçš„ç»“æœ</span></span><br><span class=\"line\">                <span class=\"keyword\">let</span> <span class=\"variable\">receive_result</span> = receiver.<span class=\"title function_ invoke__\">try_recv</span>();</span><br><span class=\"line\"></span><br><span class=\"line\">                <span class=\"keyword\">match</span> receive_result &#123;</span><br><span class=\"line\">                    <span class=\"title function_ invoke__\">Ok</span>(msg) =&gt; &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// æ‹¿æ¶ˆæ¯å¯¹è±¡ä¸­çš„å†…éƒ¨æ•°æ®</span></span><br><span class=\"line\">                        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;âœ… Consumer received: &#123;&#125;&quot;</span>, msg);</span><br><span class=\"line\">                        <span class=\"title function_ invoke__\">process_file</span>(&amp;msg);</span><br><span class=\"line\">                        <span class=\"comment\">// åŠ ç‚¹å»¶æ—¶ï¼Œçœ‹èµ·æ¥æœ‰æ•ˆæœçš„æ ·å­</span></span><br><span class=\"line\">                        thread::<span class=\"title function_ invoke__\">sleep</span>(Duration::<span class=\"title function_ invoke__\">from_millis</span>(<span class=\"number\">300</span>));</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"title function_ invoke__\">Err</span>(mpsc::TryRecvError::Empty) =&gt; &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// No message received within the timeout</span></span><br><span class=\"line\">                        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;â“ Consumer: No message available immediately.&quot;</span>);</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                    <span class=\"title function_ invoke__\">Err</span>(mpsc::TryRecvError::Disconnected) =&gt; &#123;</span><br><span class=\"line\">                        <span class=\"comment\">// Channel is disconnected, meaning all senders are dropped</span></span><br><span class=\"line\">                        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;â Consumer: Channel disconnected, exiting.&quot;</span>);</span><br><span class=\"line\">                        <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                    &#125;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;;</span><br><span class=\"line\">        <span class=\"comment\">// å› ä¸ºæˆ‘ä»¬éœ€è¦å€Ÿç”¨variablesï¼Œæˆ‘ä»¬ä½¿ç”¨scopeæ–¹æ³•å¤„ç†ç”Ÿå‘½å‘¨æœŸçš„é—®é¢˜</span></span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">handle</span> = <span class=\"title function_ invoke__\">spawn</span>(consumer);</span><br><span class=\"line\">        handles.<span class=\"title function_ invoke__\">push</span>(handle);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"comment\">// blocking main thread to wait for worker thread</span></span><br><span class=\"line\">    <span class=\"comment\">// éå†handlesï¼Œæ‰‹åŠ¨è°ƒç”¨join()æ¥é˜»å¡ä¸»çº¿ç¨‹çš„ç»ˆç»“ç­‰å¾…å·¥ä½œçº¿ç¨‹ä»»åŠ¡å®Œæˆ</span></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">handle</span> <span class=\"keyword\">in</span> handles &#123;</span><br><span class=\"line\">        handle.<span class=\"title function_ invoke__\">join</span>().<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸª« Worker thread is finished.&quot;</span>);</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;âœ… All files have processed.&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n\n\n<h2 id=\"ç»ƒä¹ 2\"><a href=\"#ç»ƒä¹ 2\" class=\"headerlink\" title=\"ç»ƒä¹ 2\"></a>ç»ƒä¹ 2</h2><p><img src=\"/../images/concurrency/image-20250131213751832.png\" alt=\"image-20250131213751832\"></p>\n<p><img src=\"/../images/concurrency/image-20250212220857490.png\" alt=\"image-20250212220857490\"></p>\n<p>é”™è¯¯æç¤º â€”â€” å½“å‰ç±»å‹ï¼ˆ <code>TaskSign</code> ï¼‰éœ€è¦æ˜¯å®ç°äº† <code>Send</code> trait çš„ç±»å‹ã€‚<code>Send</code> trait æ˜¯ä¸€ç§æ ‡è®°ï¼ˆmarkerï¼‰ç‰¹å¾ï¼Œå®ç°äº†è¯¥ç‰¹å¾çš„ç±»å‹ä¼šè¢«ç¼–è¯‘å™¨è¯†åˆ«ä¸º <strong>â€œçº¿ç¨‹å®‰å…¨çš„â€</strong>ï¼ˆthread-safeï¼‰ï¼Œè¿™æ˜¯å› ä¸ºæˆ‘ä»¬å°†æ ‡å‡†çš„ <strong>â€œä¸€ä¸ª receiverâ€</strong> å…±äº«åœ¨å¤šä¸ªçº¿ç¨‹ä¹‹é—´ï¼Œè¿™ä¸ªè¡Œä¸ºä¼šè¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çš„ï¼ˆunsafeï¼‰ã€‚æ®æŸ¥è¯¢ï¼Œå¤§éƒ¨åˆ†å†…ç½®ç±»å‹éƒ½è‡ªåŠ¨å®ç°äº† <code>Send</code> ç‰¹å¾ï¼Œéƒ¨åˆ†ç±»å‹æˆ–è€…è‡ªå®šä¹‰ç±»å‹éœ€è¦æ‰‹åŠ¨åŠ ä¸Š <code>Send</code> ç‰¹å¾ã€‚</p>\n<figure class=\"highlight rust\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br><span class=\"line\">21</span><br><span class=\"line\">22</span><br><span class=\"line\">23</span><br><span class=\"line\">24</span><br><span class=\"line\">25</span><br><span class=\"line\">26</span><br><span class=\"line\">27</span><br><span class=\"line\">28</span><br><span class=\"line\">29</span><br><span class=\"line\">30</span><br><span class=\"line\">31</span><br><span class=\"line\">32</span><br><span class=\"line\">33</span><br><span class=\"line\">34</span><br><span class=\"line\">35</span><br><span class=\"line\">36</span><br><span class=\"line\">37</span><br><span class=\"line\">38</span><br><span class=\"line\">39</span><br><span class=\"line\">40</span><br><span class=\"line\">41</span><br><span class=\"line\">42</span><br><span class=\"line\">43</span><br><span class=\"line\">44</span><br><span class=\"line\">45</span><br><span class=\"line\">46</span><br><span class=\"line\">47</span><br><span class=\"line\">48</span><br><span class=\"line\">49</span><br><span class=\"line\">50</span><br><span class=\"line\">51</span><br><span class=\"line\">52</span><br><span class=\"line\">53</span><br><span class=\"line\">54</span><br><span class=\"line\">55</span><br><span class=\"line\">56</span><br><span class=\"line\">57</span><br><span class=\"line\">58</span><br><span class=\"line\">59</span><br><span class=\"line\">60</span><br><span class=\"line\">61</span><br><span class=\"line\">62</span><br><span class=\"line\">63</span><br><span class=\"line\">64</span><br><span class=\"line\">65</span><br><span class=\"line\">66</span><br><span class=\"line\">67</span><br><span class=\"line\">68</span><br><span class=\"line\">69</span><br><span class=\"line\">70</span><br><span class=\"line\">71</span><br><span class=\"line\">72</span><br><span class=\"line\">73</span><br><span class=\"line\">74</span><br><span class=\"line\">75</span><br><span class=\"line\">76</span><br><span class=\"line\">77</span><br><span class=\"line\">78</span><br><span class=\"line\">79</span><br><span class=\"line\">80</span><br><span class=\"line\">81</span><br><span class=\"line\">82</span><br><span class=\"line\">83</span><br><span class=\"line\">84</span><br><span class=\"line\">85</span><br><span class=\"line\">86</span><br><span class=\"line\">87</span><br><span class=\"line\">88</span><br><span class=\"line\">89</span><br><span class=\"line\">90</span><br><span class=\"line\">91</span><br><span class=\"line\">92</span><br><span class=\"line\">93</span><br><span class=\"line\">94</span><br><span class=\"line\">95</span><br><span class=\"line\">96</span><br><span class=\"line\">97</span><br><span class=\"line\">98</span><br><span class=\"line\">99</span><br><span class=\"line\">100</span><br><span class=\"line\">101</span><br><span class=\"line\">102</span><br><span class=\"line\">103</span><br><span class=\"line\">104</span><br><span class=\"line\">105</span><br><span class=\"line\">106</span><br><span class=\"line\">107</span><br><span class=\"line\">108</span><br><span class=\"line\">109</span><br><span class=\"line\">110</span><br><span class=\"line\">111</span><br><span class=\"line\">112</span><br><span class=\"line\">113</span><br><span class=\"line\">114</span><br><span class=\"line\">115</span><br><span class=\"line\">116</span><br><span class=\"line\">117</span><br><span class=\"line\">118</span><br></pre></td><td class=\"code\"><pre><span class=\"line\"><span class=\"keyword\">use</span> std::&#123;</span><br><span class=\"line\">    sync::&#123;</span><br><span class=\"line\">        mpsc::&#123;<span class=\"keyword\">self</span>, Receiver, Sender&#125;,</span><br><span class=\"line\">        Arc, Mutex,</span><br><span class=\"line\">    &#125;,</span><br><span class=\"line\">    thread::&#123;sleep, spawn, JoinHandle&#125;,</span><br><span class=\"line\">    time::Duration,</span><br><span class=\"line\">&#125;;</span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Task</span> &#123;</span><br><span class=\"line\">    id: <span class=\"type\">usize</span>,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">impl</span> <span class=\"title class_\">Task</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">new</span>(id: <span class=\"type\">usize</span>) <span class=\"punctuation\">-&gt;</span> <span class=\"keyword\">Self</span> &#123;</span><br><span class=\"line\">        Task &#123; id &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">run</span>(&amp;<span class=\"keyword\">self</span>) &#123;</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;âœ… Executing task &#123;&#125;&quot;</span>, <span class=\"keyword\">self</span>.id);</span><br><span class=\"line\">        <span class=\"title function_ invoke__\">sleep</span>(Duration::<span class=\"title function_ invoke__\">from_secs</span>(<span class=\"number\">1</span>));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">Worker</span> &#123;</span><br><span class=\"line\">    id: <span class=\"type\">usize</span>,</span><br><span class=\"line\">    <span class=\"comment\">// JoinHandle&lt;T&gt;, T refers to return value type of spawn()</span></span><br><span class=\"line\">    handle: JoinHandle&lt;()&gt;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">enum</span> <span class=\"title class_\">TaskSign</span> &#123;</span><br><span class=\"line\">    <span class=\"title function_ invoke__\">Task</span>(Task),</span><br><span class=\"line\">    End,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">type</span> <span class=\"title class_\">SharedReceiver</span> = Arc&lt;Mutex&lt;Receiver&lt;TaskSign&gt;&gt;&gt;;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"comment\">// å·¥ä½œçº¿ç¨‹æ± </span></span><br><span class=\"line\"><span class=\"comment\">// æ§åˆ¶å†…éƒ¨å·¥ä½œçº¿ç¨‹çš„å·¥ä½œå’Œåœæ­¢</span></span><br><span class=\"line\"><span class=\"keyword\">struct</span> <span class=\"title class_\">WorkerThreads</span> &#123;</span><br><span class=\"line\">    threads: <span class=\"type\">Vec</span>&lt;Worker&gt;,</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">impl</span> <span class=\"title class_\">Worker</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">new</span>(id: <span class=\"type\">usize</span>, handle: JoinHandle&lt;()&gt;) <span class=\"punctuation\">-&gt;</span> <span class=\"keyword\">Self</span> &#123;</span><br><span class=\"line\">        Worker &#123; id, handle &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">impl</span> <span class=\"title class_\">WorkerThreads</span> &#123;</span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">new</span>() <span class=\"punctuation\">-&gt;</span> <span class=\"keyword\">Self</span> &#123;</span><br><span class=\"line\">        WorkerThreads &#123; threads: <span class=\"built_in\">vec!</span>[] &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// æ–°å¢ä¸€ä¸ªå·¥ä½œçº¿ç¨‹ï¼Œæ¯ä¸ªå·¥ä½œçº¿ç¨‹çš„ä»»åŠ¡æ˜¯æŒç»­æŸ¥è¯¢ receiver</span></span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">add_worker</span>(&amp;<span class=\"keyword\">mut</span> <span class=\"keyword\">self</span>, receiver: SharedReceiver) <span class=\"punctuation\">-&gt;</span> <span class=\"type\">usize</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">index</span> = <span class=\"keyword\">self</span>.threads.<span class=\"title function_ invoke__\">len</span>();</span><br><span class=\"line\">        <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸ”‘ New worker thread &#123;&#125;&quot;</span>, index + <span class=\"number\">1</span>);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">handle</span> = <span class=\"title function_ invoke__\">spawn</span>(<span class=\"keyword\">move</span> || <span class=\"keyword\">loop</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">match</span> receiver.<span class=\"title function_ invoke__\">lock</span>().<span class=\"title function_ invoke__\">unwrap</span>().<span class=\"title function_ invoke__\">recv</span>() &#123;</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">Ok</span>(TaskSign::End) =&gt; &#123;</span><br><span class=\"line\">                    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸš¦ Worker thread &#123;&#125; getting end signal.&quot;</span>, index + <span class=\"number\">1</span>);</span><br><span class=\"line\">                    <span class=\"comment\">// æ¥æ”¶åˆ°åœæ­¢ä¿¡å·ï¼Œç»ˆç»“å¾ªç¯</span></span><br><span class=\"line\">                    <span class=\"keyword\">break</span>;</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">Ok</span>(TaskSign::<span class=\"title function_ invoke__\">Task</span>(task)) =&gt; &#123;</span><br><span class=\"line\">                    <span class=\"built_in\">println!</span>(</span><br><span class=\"line\">                        <span class=\"string\">&quot;â© Worker thread &#123;&#125; is processing the task &#123;&#125;.&quot;</span>,</span><br><span class=\"line\">                        index + <span class=\"number\">1</span>,</span><br><span class=\"line\">                        task.id</span><br><span class=\"line\">                    );</span><br><span class=\"line\">                    task.<span class=\"title function_ invoke__\">run</span>();</span><br><span class=\"line\">                  </span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">                <span class=\"title function_ invoke__\">Err</span>(e) =&gt; &#123;</span><br><span class=\"line\">                    <span class=\"built_in\">eprintln!</span>(<span class=\"string\">&quot;âŒ Worker thread &#123;&#125; error: &#123;&#125;&quot;</span>, index + <span class=\"number\">1</span>, e);</span><br><span class=\"line\">                &#125;</span><br><span class=\"line\">            &#125;</span><br><span class=\"line\">        &#125;);</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">worker</span> = Worker::<span class=\"title function_ invoke__\">new</span>(index, handle);</span><br><span class=\"line\">        <span class=\"keyword\">self</span>.threads.<span class=\"title function_ invoke__\">push</span>(worker);</span><br><span class=\"line\">        index</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">    <span class=\"comment\">// åœæ­¢æ‰€æœ‰å·¥ä½œçº¿ç¨‹ï¼Œå‘æ‰€æœ‰å·¥ä½œçº¿ç¨‹å‘é€åœæ­¢æ ‡å¿—</span></span><br><span class=\"line\">    <span class=\"keyword\">fn</span> <span class=\"title function_\">stop</span>(&amp;<span class=\"keyword\">self</span>, transmitter: &amp;Sender&lt;TaskSign&gt;) <span class=\"punctuation\">-&gt;</span> () &#123;</span><br><span class=\"line\">        <span class=\"keyword\">for</span> <span class=\"variable\">_</span> <span class=\"keyword\">in</span> <span class=\"number\">0</span>..<span class=\"keyword\">self</span>.threads.<span class=\"title function_ invoke__\">len</span>() &#123;</span><br><span class=\"line\">            transmitter.<span class=\"title function_ invoke__\">send</span>(TaskSign::End).<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br><span class=\"line\"><span class=\"keyword\">pub</span> <span class=\"keyword\">fn</span> <span class=\"title function_\">main</span>() &#123;</span><br><span class=\"line\">    <span class=\"comment\">// å·¥ä½œçº¿ç¨‹æ± </span></span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"keyword\">mut </span><span class=\"variable\">worker_thread_pool</span> = WorkerThreads::<span class=\"title function_ invoke__\">new</span>();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> (send_tx, send_rx) = mpsc::channel::&lt;TaskSign&gt;();</span><br><span class=\"line\">    <span class=\"keyword\">let</span> <span class=\"variable\">shared_rx</span> = Arc::<span class=\"title function_ invoke__\">new</span>(Mutex::<span class=\"title function_ invoke__\">new</span>(send_rx));</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">_</span> <span class=\"keyword\">in</span> <span class=\"number\">0</span>..<span class=\"number\">4</span> &#123;</span><br><span class=\"line\">        <span class=\"comment\">// create worker threads</span></span><br><span class=\"line\">        worker_thread_pool.<span class=\"title function_ invoke__\">add_worker</span>(Arc::<span class=\"title function_ invoke__\">clone</span>(&amp;shared_rx));</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">i</span> <span class=\"keyword\">in</span> <span class=\"number\">0</span>..<span class=\"number\">10</span> &#123;</span><br><span class=\"line\">        <span class=\"keyword\">let</span> <span class=\"variable\">id</span> = i + <span class=\"number\">1</span>;</span><br><span class=\"line\">        <span class=\"keyword\">if</span> id == <span class=\"number\">6</span> &#123;</span><br><span class=\"line\">            WorkerThreads::<span class=\"title function_ invoke__\">stop</span>(&amp;worker_thread_pool, &amp;send_tx);</span><br><span class=\"line\">            <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸ¯ Main thread has sended end signal on task &#123;&#125;.&quot;</span>, id);</span><br><span class=\"line\">        &#125; <span class=\"keyword\">else</span> &#123;</span><br><span class=\"line\">            <span class=\"keyword\">let</span> <span class=\"variable\">task</span> = Task::<span class=\"title function_ invoke__\">new</span>(id);</span><br><span class=\"line\">            send_tx.<span class=\"title function_ invoke__\">send</span>(TaskSign::<span class=\"title function_ invoke__\">Task</span>(task)).<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">            <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;ğŸ§± Main thread has sended task &#123;&#125;.&quot;</span>, id);</span><br><span class=\"line\">        &#125;</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"keyword\">for</span> <span class=\"variable\">worker</span> <span class=\"keyword\">in</span> worker_thread_pool.threads &#123;</span><br><span class=\"line\">        worker.handle.<span class=\"title function_ invoke__\">join</span>().<span class=\"title function_ invoke__\">unwrap</span>();</span><br><span class=\"line\">    &#125;</span><br><span class=\"line\"></span><br><span class=\"line\">    <span class=\"built_in\">println!</span>(<span class=\"string\">&quot;âœ… All tasks are finished !!&quot;</span>);</span><br><span class=\"line\">&#125;</span><br><span class=\"line\"></span><br></pre></td></tr></table></figure>\n\n\n\n<p><strong>é‡ç‚¹å®ç°åˆ†æï¼š</strong></p>\n<ol>\n<li>åˆ›å»ºäº†ä¸€ä¸ªå·¥ä½œçº¿ç¨‹æ± ç»“æ„ä½“ï¼Œæ¥ç®¡ç†å­çº¿ç¨‹çš„åˆ›å»ºå’Œåœæ­¢ï¼Œåœæ­¢æ„å‘³ç€å‘æ‰€æœ‰å­çº¿ç¨‹å‘é€åœæ­¢ä¿¡å·ã€‚</li>\n<li>å­çº¿ç¨‹è´Ÿè´£æŒç»­å‘ receiver æŸ¥è¯¢ä»»åŠ¡ï¼Œå½“å­çº¿ç¨‹æ¥æ”¶åˆ°åœæ­¢ä¿¡å·æ—¶ï¼Œåˆ™ç»ˆç»“å¾ªç¯ã€‚</li>\n<li>æ”¶é›†æ‰€æœ‰å­çº¿ç¨‹è¿”å›çš„ joinHandleï¼Œåˆ†åˆ«è°ƒç”¨ join() æ–¹æ³•ä»¥é˜»å¡ä¸»çº¿ç¨‹ï¼Œç­‰å¾…å­çº¿ç¨‹çš„æ‰§è¡Œã€‚</li>\n<li>ä¼˜é›…åœæ­¢çš„ç§˜è¯€ï¼šåœ¨å­çº¿ç¨‹çš„loopå¾ªç¯ä¸­åˆ¤æ–­æ˜¯å¦è¿˜èƒ½æ¥ç»­æ¥æ”¶ä»»åŠ¡ï¼Œè‹¥ä¸è¡Œåˆ™è·³å‡ºå¾ªç¯ï¼Œä¸å†æ¥æ”¶æ–°ä»»åŠ¡ã€‚</li>\n</ol>\n","text":"Concurrency in Ruståœ¨ Rust ä¸­ï¼Œå¹¶å‘ï¼ˆConcurrencyï¼‰æ˜¯ä¸€é¡¹æ ¸å¿ƒåŠŸèƒ½ï¼Œæ—¨åœ¨å®‰å…¨é«˜æ•ˆçš„åŒæ—¶æ‰§è¡Œå¤šä¸ªä»»åŠ¡ã€‚ Spawning Thr...","permalink":"/post/concurrency","photos":[],"count_time":{"symbolsCount":"14k","symbolsTime":"12 mins."},"categories":[],"tags":[{"name":"rust","slug":"rust","count":13,"path":"api/tags/rust.json"}],"toc":"<ol class=\"toc\"><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Concurrency-in-Rust\"><span class=\"toc-text\">Concurrency in Rust</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Spawning-Thread\"><span class=\"toc-text\">Spawning Thread</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Creating-new-thread\"><span class=\"toc-text\">Creating new thread</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#std-thread-spawn-closure\"><span class=\"toc-text\">std::thread::spawn(closure)</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#join-%E6%96%B9%E6%B3%95\"><span class=\"toc-text\">join æ–¹æ³•</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Thread-variables-%E7%BA%BF%E7%A8%8B%E5%8F%98%E9%87%8F\"><span class=\"toc-text\">Thread variables çº¿ç¨‹å˜é‡</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#move-closure-%E4%BD%BF%E7%94%A8-move-%E5%85%B3%E9%94%AE%E5%AD%97%E5%B0%86%E5%8F%98%E9%87%8F%E7%9A%84%E6%95%B0%E6%8D%AE%E6%89%80%E6%9C%89%E6%9D%83%E8%BD%AC%E7%A7%BB%E5%88%B0%E9%97%AD%E5%8C%85%E5%86%85\"><span class=\"toc-text\">move closure ä½¿ç”¨ move å…³é”®å­—å°†å˜é‡çš„æ•°æ®æ‰€æœ‰æƒè½¬ç§»åˆ°é—­åŒ…å†…</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#std-thread-scope\"><span class=\"toc-text\">std::thread::scope</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#Message-Passing-with-MPSC-channels\"><span class=\"toc-text\">Message Passing with MPSC channels</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E9%80%9A%E4%BF%A1%E5%8E%9F%E5%88%99\"><span class=\"toc-text\">é€šä¿¡åŸåˆ™</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#%E5%A4%9A%E4%B8%AA%E7%94%9F%E4%BA%A7%E8%80%85-multiple-producers\"><span class=\"toc-text\">å¤šä¸ªç”Ÿäº§è€… multiple producers</span></a></li><li class=\"toc-item toc-level-3\"><a class=\"toc-link\" href=\"#Sharing-data-within-multiple-threads\"><span class=\"toc-text\">Sharing data within multiple threads</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Mutex-%E4%BA%92%E6%96%A5%E9%94%81-%E6%98%AF%E4%BB%80%E4%B9%88\"><span class=\"toc-text\">Mutex äº’æ–¥é” æ˜¯ä»€ä¹ˆ</span></a></li><li class=\"toc-item toc-level-4\"><a class=\"toc-link\" href=\"#Mutex-%E6%80%8E%E4%B9%88%E4%BD%BF%E7%94%A8\"><span class=\"toc-text\">Mutex æ€ä¹ˆä½¿ç”¨</span></a><ol class=\"toc-child\"><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E5%88%9B%E5%BB%BA\"><span class=\"toc-text\">åˆ›å»º</span></a></li><li class=\"toc-item toc-level-5\"><a class=\"toc-link\" href=\"#%E8%AE%BF%E9%97%AE\"><span class=\"toc-text\">è®¿é—®</span></a></li></ol></li></ol></li></ol></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BB%83%E4%B9%A01\"><span class=\"toc-text\">ç»ƒä¹ 1</span></a></li><li class=\"toc-item toc-level-2\"><a class=\"toc-link\" href=\"#%E7%BB%83%E4%B9%A02\"><span class=\"toc-text\">ç»ƒä¹ 2</span></a></li></ol>","author":{"name":"Marnie","slug":"blog-author","avatar":"/images/favicon.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}},"mapped":true,"hidden":false,"prev_post":{},"next_post":{"title":"Rust Test","uid":"acc0e87b34830b962966d84f538705e6","slug":"rust-test","date":"2025-01-27T02:12:05.000Z","updated":"2025-01-27T10:59:10.090Z","comments":true,"path":"api/articles/rust-test.json","keywords":"","cover":[],"text":"Unit Testå•å…ƒæµ‹è¯• 123456789101112131415161718192021222324252627282930313233343536373...","permalink":"/post/rust-test","photos":[],"count_time":{"symbolsCount":"6.1k","symbolsTime":"6 mins."},"categories":[],"tags":[{"name":"rust","slug":"rust","count":13,"path":"api/tags/rust.json"}],"author":{"name":"Marnie","slug":"blog-author","avatar":"/images/favicon.png","link":"/","description":"","socials":{"github":"","twitter":"","stackoverflow":"","wechat":"","qq":"","weibo":"","zhihu":"","csdn":"","juejin":"","customs":{}}}}}